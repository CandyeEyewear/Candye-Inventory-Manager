<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Candye Supplier OOS Cleaner — Reference-First Flow (robust XLSX/CSV)</title>
  <style>
    :root{
      /* Light theme */
      --bg:#ffffff;            /* page background */
      --card:#fdfdfd;          /* card background */
      --fg:#1f2937;            /* text */
      --muted:#6b7280;         /* muted text */
      --border:#e5e7eb;        /* borders */
      --shadow:0 2px 8px rgba(0,0,0,.06);

      /* Brand accents */
      --peach:#FFDAB9;         /* button base */
      --peach-hover:#FBC9A7;   /* button hover */
      --green:#34d399;         /* selected/active */
      --amber:#fbbf24;         /* dropzone border */
      --ok:#34d399;
      --warn:#f59e0b;
      --err:#ef4444;

      --radius:14px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--fg);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial
    }

    .wrap{max-width:1200px;margin:40px auto;padding:0 16px}
    h1{font-size:clamp(20px,2.4vw,28px);margin:0 0 10px;color:#111827}
    strong{color:#111827}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:var(--shadow);
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grid{display:grid;gap:14px}
    .cols-2{grid-template-columns:1fr 1fr}

    /* Inputs */
    input[type="number"],input[type="text"],input[type="checkbox"],select{font:inherit}
    input[type="number"],input[type="text"],select{
      width:100%;padding:10px;border:1px solid var(--border);
      background:#fff;color:var(--fg);border-radius:10px;
      transition:border .2s, box-shadow .2s;
    }
    input:focus,select:focus{
      border-color:var(--green);
      box-shadow:0 0 0 2px rgba(52,211,153,.2);
      outline:none;
    }
    label{color:var(--fg);font-weight:500}

    /* Buttons: peach -> green when active/selected */
    .btn{
      appearance:none;border:1px solid var(--border);
      background:var(--peach);color:var(--fg);
      padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;
      transition:background .2s, border-color .2s, color .2s, transform .05s;
    }
    .btn:hover{ background:var(--peach-hover); }
    .btn:active,.btn.selected{ background:var(--green); color:#fff; border-color:var(--green); }
    .btn:disabled{opacity:.6;cursor:not-allowed}

    /* Legacy variants still look good in the new scheme */
    .btn.primary{ /* keep same look as base peach; :active turns green */
      background:var(--peach);
    }
    .btn.success{ background:var(--green); color:#fff; border-color:var(--green); }

    /* Dropzones: visible on white */
    .drop{
      border:2px dashed var(--amber);
      border-radius:12px;padding:16px;text-align:center;
      background:#fffaf5;color:var(--muted);
      transition:background .2s, border-color .2s;
    }
    .drop.drag{ border-color:var(--green); background:#fff3eb; }

    /* Key-value layout */
    .kv{display:grid;grid-template-columns:220px 1fr;gap:10px;align-items:center}

    /* Tables */
    .table-wrap{
      max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:12px;background:#fff;
    }
    table{border-collapse:collapse;width:100%;font-size:14px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left}
    th{position:sticky;top:0;background:#f9fafb;color:#111827}
    tbody tr:nth-child(even){background:#f9fafb}
    tr:hover td{background:#f3f4f6}

    .muted{color:var(--muted)}
    .badge{display:inline-block;background:#fff;border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:12px}
    .sep{height:1px;background:var(--border);margin:12px 0}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:12px;color:var(--fg)}

    .ok{color:var(--ok)} .err{color:var(--err)} .warn{color:var(--warn)}
    .hint{font-size:12px;color:var(--muted)}

    .sticky-actions{
      position:sticky;bottom:0;
      background:linear-gradient(180deg, rgba(253,253,253,0), #fdfdfd 40%);
      padding-top:8px
    }

    .tags-input{
      width:100%;padding:6px 8px;border:1px solid var(--border);background:#fff;color:var(--fg);border-radius:8px
    }

    /* Toast fits light UI but keeps strong border colors by type */
    .toast{
      position:fixed;right:16px;bottom:16px;background:#fff;border:1px solid var(--border);
      padding:10px 14px;border-radius:10px;max-width:360px;box-shadow:var(--shadow);color:var(--fg)
    }

    .progress{display:flex;align-items:center;gap:10px}
    .progress progress{width:240px;height:16px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Supplier OOS Cleaner <span class="badge" id="status-badge">Load product export first</span></h1>

  <div class="card grid" style="gap:18px">
    <!-- STEP 1: Base reference (Shopify Product Export) -->
    <div class="grid">
      <div class="row" style="justify-content:space-between">
        <strong>Step 1 — Upload Shopify Product Export (base reference)</strong>
        <span class="pill" id="ref-status">Not loaded</span>
      </div>
      <div class="drop" id="ref-drop">
        <p><strong>Drop Shopify Product Export</strong> (CSV / XLSX / XLSM) — <label class="btn">Browse <input id="ref-file" type="file" accept=".csv,.xlsx,.xls,.xlsm" hidden></label></p>
        <p class="hint">We build a reference map: <em>numeric SKU core</em> → { Handle, Title, Options, Full SKU, Tags }.</p>
        <div class="progress"><label>Progress</label><progress id="refProgress" max="100" value="0"></progress><span id="refProgressText" class="muted"></span></div>
        <p class="hint" id="lib-hint">Excel library will auto-load when needed.</p>
      </div>
      <div class="row muted" id="ref-summary"></div>
    </div>

    <div class="sep"></div>

    <!-- STEP 2: Supplier Excel + Build previews -->
    <div class="grid cols-2">
      <div class="grid">
        <div class="row" style="justify-content:space-between">
          <strong>Step 2 — Upload Supplier File (extract cores like 1234-5)</strong>
          <span class="pill" id="sup-status">Waiting</span>
        </div>
        <div class="drop" id="sup-drop">
          <p><strong>Drop Supplier File</strong> (XLSX / XLSM / CSV) — <label class="btn">Browse <input id="sup-file" type="file" accept=".xlsx,.xls,.xlsm,.csv" hidden></label></p>
          <p class="hint">We auto-pick the sheet with the most matches, or use CSV directly. You can also override the sheet below.</p>
          <div class="kv"><label>Sheet override (if XLSX/XLSM)</label><select id="sheetSelect" disabled><option value="">— auto —</option></select></div>
          <div class="progress"><label>Progress</label><progress id="supProgress" max="100" value="0"></progress><span id="supProgressText" class="muted"></span></div>
        </div>

        <div class="grid" style="margin-top:8px">
          <div class="kv"><label>Inventory Location (exact)</label><input id="invLocation" type="text" placeholder="e.g., WOHU"></div>
          <div class="kv"><label>Set Available to (WOHU)</label><input id="invAvailable" type="number" value="0" min="0"></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="build-inventory" class="btn primary" disabled>Build Inventory Preview</button>
          <button id="build-tags" class="btn" disabled>Build Tags Preview</button>
        </div>

        <div class="row muted" id="match-summary"></div>
      </div>

      <div class="grid">
        <strong>Inventory Preview</strong>
        <div class="table-wrap">
          <table id="inv-table"><thead><tr>
            <th>Handle</th>
            <th>Title</th>
            <th>Option1 Name</th><th>Option1 Value</th>
            <th>Option2 Name</th><th>Option2 Value</th>
            <th>Option3 Name</th><th>Option3 Value</th>
            <th>SKU</th>
            <th>WOHU</th>
          </tr></thead><tbody></tbody></table>
        </div>
        <div class="sticky-actions row">
          <button id="download-inventory" class="btn" disabled>Download Inventory CSV</button>
        </div>
      </div>
    </div>

    <div class="sep"></div>

    <!-- STEP 2b: Unmatched cores -->
    <div class="grid">
      <strong>Unmatched variant cores (send to supplier)</strong>
      <div class="table-wrap">
        <table id="unmatched-table"><thead><tr>
          <th>Variant core (digits-digits)</th>
        </tr></thead><tbody></tbody></table>
      </div>
      <div class="sticky-actions row">
        <button id="download-unmatched" class="btn" disabled>Download Unmatched CSV</button>
      </div>
    </div>

    <div class="sep"></div>

    <!-- STEP 3: Tags preview -->
    <div class="grid">
      <strong>Tags Preview (edit per row)</strong>
      <div class="row" style="align-items:center;gap:16px">
        <label><input type="checkbox" id="appendExisting" checked> Append to existing tags (recommended)</label>
        <span class="hint">If unchecked, only the tags you type will be used.</span>
      </div>
      <div class="row" style="align-items:center;gap:10px">
        <div class="kv" style="grid-template-columns:140px 420px"><label>Global tags</label><input id="globalTags" type="text" placeholder="e.g., delisted, supplier-oos"></div>
        <button id="apply-global-tags" class="btn">Apply to all rows</button>
      </div>
      <div class="table-wrap">
        <table id="tags-table"><thead><tr>
          <th>Handle</th>
          <th>Title</th>
          <th>Variant SKU</th>
          <th>Existing Tags</th>
          <th>Tags to Add (comma-separated)</th>
        </tr></thead><tbody></tbody></table>
      </div>
      <div class="sticky-actions row">
        <button id="download-tags" class="btn" disabled>Download Tags CSV</button>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast" style="display:none"></div>

<script>
// ===== Toast =====
function toast(msg, type='warn'){
  const el=document.getElementById('toast');
  el.textContent=msg;
  el.style.display='block';
  el.style.borderColor= type==='err' ? '#ef4444' : (type==='ok' ? '#34d399' : '#f59e0b');
  setTimeout(()=>{ el.style.display='none'; }, 4500);
}

// ===== XLSX Loader (on demand) =====
const XLSX_CDNS = [
  'https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js',
  'https://unpkg.com/xlsx@0.19.3/dist/xlsx.full.min.js',
  'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js'
];
function loadScript(src){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.async=true;s.crossOrigin='anonymous';s.onload=()=>res(src);s.onerror=()=>rej(new Error('Failed '+src));document.head.appendChild(s);});}
async function ensureXLSX(){ if(window.XLSX) return true; const hint=document.getElementById('lib-hint'); for(const src of XLSX_CDNS){ try{ hint.textContent='Loading XLSX from '+new URL(src).host+'…'; await loadScript(src); if(window.XLSX) return true; }catch(e){} } toast('Excel library failed to load. You can still upload CSV files.', 'err'); return false; }

// ===== State =====
const $ = id => document.getElementById(id);
const badge = $('status-badge'); const setBadge=t=>badge.textContent=t;
let refRows = [];   // product export CSV rows (AoA)
let refHeaders = []; // header names
let variants = [];  // [{handle,title,opt1n,opt1v,opt2n,opt2v,opt3n,opt3v,sku,existingTags, core}]
let byCore = new Map(); // core -> variant[]    core=digits-digits
let supplierRows = [];  // AoA (chosen sheet or CSV)
let supplierCores = new Set(); // extracted cores from supplier file
let invPreview = []; // rows for inventory
let tagsPreview = []; // rows for tags table
let unmatchedCores = []; // array of cores without matches
let lastWb = null; // keep workbook for sheet picker

// ===== Utils =====
function parseCSV(text){ const lines = text.split(/\r?\n/); const rows=[]; for(const line of lines){ if(line==='') continue; rows.push(parseCSVLine(line)); } return rows; }
function parseCSVLine(line){ const out=[]; let cur=''; let inQ=false; for(let i=0;i<line.length;i++){ const ch=line[i]; if(inQ){ if(ch==='"'){ if(line[i+1]==='"'){cur+='"';i++;} else {inQ=false;} } else { cur+=ch; } } else { if(ch==='"'){ inQ=true; } else if(ch===','){ out.push(cur); cur=''; } else { cur+=ch; } } } out.push(cur); return out; }
function getIdx(headers, name){ return headers.findIndex(h=>String(h).trim().toLowerCase()===name.toLowerCase()); }
function coreFromSKU(s){ if(!s) return null; const m=String(s).match(/(\d{3,6}-\d{1,3})/); return m? m[1] : null; }
function q(v){ return '"'+String(v??'').replace(/"/g,'""')+'"'; }
function downloadCSV(filename, headers, rows){ const lines=[headers.join(',')]; for(const r of rows){ lines.push(headers.map(h=>q(r[h])).join(',')); } const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove();},0); }

function updateProgress(elBar, elText, value, text){ if(typeof value==='number'){ elBar.value = Math.max(0, Math.min(100, value)); } if(text!=null){ elText.textContent = text; } }

// ===== Reference (Product Export) loader =====
async function handleRefFile(file){ const name=file.name.toLowerCase(); let rows; const prog=$('refProgress'), ptext=$('refProgressText'); updateProgress(prog,ptext,5,'Reading…');
  if(name.endsWith('.csv')){ const r=new FileReader(); r.onprogress=e=>{ if(e.lengthComputable) updateProgress(prog,ptext, Math.round((e.loaded/e.total)*80), 'Reading CSV…'); }; rows = await new Promise(ok=>{ r.onload=()=>ok(parseCSV(r.result)); r.readAsText(file); }); }
  else { const ok = await ensureXLSX(); if(!ok){ toast('Could not load Excel library — export your product file as CSV and upload that.', 'err'); return; } const r=new FileReader(); r.onprogress=e=>{ if(e.lengthComputable) updateProgress(prog,ptext, Math.round((e.loaded/e.total)*60), 'Reading XLSX…'); }; rows = await new Promise(ok=>{ r.onload=()=>{ const wb=XLSX.read(new Uint8Array(r.result),{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]]; ok(XLSX.utils.sheet_to_json(ws,{header:1,raw:true,defval:''})); }; r.readAsArrayBuffer(file); }); }
  if(!rows || rows.length===0){ $('ref-status').textContent='Failed to read file'; $('ref-status').className='pill err'; updateProgress(prog,ptext,0,''); return; }
  refRows = rows; refHeaders = rows[0].map(h=>String(h).trim());
  const needed = ['Handle','Title','Variant SKU','Option1 Name','Option1 Value','Option2 Name','Option2 Value','Option3 Name','Option3 Value','Tags'];
  const missing = needed.filter(h=>getIdx(refHeaders,h)===-1);
  if(missing.length){ $('ref-summary').textContent = 'Missing columns in export: '+missing.join(', ')+'. Export all columns from Shopify.'; $('ref-summary').className='row err'; }
  // Build variants and byCore
  variants = []; byCore.clear();
  const total = rows.length||1; let processed=0;
  for(let r=1;r<rows.length;r++){
    const row = rows[r]; processed++; if(processed%200===0) updateProgress(prog,ptext, 80 + Math.round((processed/total)*20), 'Indexing…');
    if(!row || row.length===0) continue;
    const handle = row[getIdx(refHeaders,'Handle')]||'';
    const title  = row[getIdx(refHeaders,'Title')]||'';
    const sku    = row[getIdx(refHeaders,'Variant SKU')]||'';
    const opt1n  = row[getIdx(refHeaders,'Option1 Name')]||''; const opt1v = row[getIdx(refHeaders,'Option1 Value')]||'';
    const opt2n  = row[getIdx(refHeaders,'Option2 Name')]||''; const opt2v = row[getIdx(refHeaders,'Option2 Value')]||'';
    const opt3n  = row[getIdx(refHeaders,'Option3 Name')]||''; const opt3v = row[getIdx(refHeaders,'Option3 Value')]||'';
    const tags   = row[getIdx(refHeaders,'Tags')]||'';
    const core   = coreFromSKU(sku);
    if(!core) continue;
    const v = {handle,title,sku,opt1n,opt1v,opt2n,opt2v,opt3n,opt3v,existingTags:tags, core};
    variants.push(v);
    if(!byCore.has(core)) byCore.set(core, []);
    byCore.get(core).push(v);
  }
  $('ref-status').textContent = 'Loaded'; $('ref-status').className='pill ok';
  $('ref-summary').textContent = `Reference variants: ${variants.length}. Unique cores: ${byCore.size}.`;
  setBadge('Reference ready — now add supplier file');
  $('build-inventory').disabled = false; $('build-tags').disabled = false;
  updateProgress(prog,ptext,100,'Done');
}

// ===== Supplier loader (auto-pick best sheet; supports CSV) =====
async function handleSupFile(file){ const name=file.name.toLowerCase(); const prog=$('supProgress'), ptext=$('supProgressText'); updateProgress(prog,ptext,5,'Reading…');
  $('sheetSelect').innerHTML = '<option value="">— auto —</option>'; $('sheetSelect').disabled = true; lastWb = null;
  if(name.endsWith('.csv')){
    const r=new FileReader(); r.onprogress=e=>{ if(e.lengthComputable) updateProgress(prog,ptext, Math.round((e.loaded/e.total)*80), 'Reading CSV…'); };
    const rows = await new Promise(ok=>{ r.onload=()=>ok(parseCSV(r.result)); r.readAsText(file); });
    setSupplierFromRows(rows, '(CSV)');
    updateProgress(prog,ptext,100,'Done');
    return;
  }
  const ok = await ensureXLSX(); if(!ok){ toast('Excel library not loaded and supplier file is not CSV. Please Save As CSV or check network.', 'err'); updateProgress(prog,ptext,0,''); return; }
  const r=new FileReader(); r.onprogress=e=>{ if(e.lengthComputable) updateProgress(prog,ptext, Math.round((e.loaded/e.total)*60), 'Reading XLSX…'); };
  const wb = await new Promise(ok=>{ r.onload=()=>ok(XLSX.read(new Uint8Array(r.result),{type:'array'})); r.readAsArrayBuffer(file); });
  lastWb = wb;
  // Populate sheet picker
  const sel = $('sheetSelect'); sel.disabled = false; sel.innerHTML = '<option value="">— auto —</option>' + wb.SheetNames.map(n=>`<option value="${n}">${n}</option>`).join('');
  // choose sheet with most cores
  chooseBestSheetAndSet(wb);
  updateProgress(prog,ptext,100,'Done');
}

function chooseBestSheetAndSet(wb){
  let bestSheet=null, bestCount=-1, bestRows=null;
  for(const name of wb.SheetNames){
    const ws=wb.Sheets[name]; const rows = XLSX.utils.sheet_to_json(ws,{header:1,raw:true,defval:null});
    let count=0; for(const row of rows){ if(!row) continue; for(const cell of row){ if(cell==null) continue; const m=String(cell).match(/\b(\d{3,6}-\d{1,3})\b/g); if(m) count+=m.length; } }
    if(count>bestCount){ bestCount=count; bestSheet=name; bestRows=rows; }
  }
  if(!bestRows || bestCount<=0){ toast('No variant cores like 1234-5 found in any sheet.', 'warn'); $('sup-status').textContent='No matches'; $('sup-status').className='pill warn'; return; }
  setSupplierFromRows(bestRows, bestSheet, bestCount);
}

function setSupplierFromRows(rows, sheetName='(CSV)', coreCount=null){
  supplierRows = rows;
  supplierCores = new Set();
  const total = rows.length||1; let processed=0;
  for(const row of rows){ processed++; if(processed%200===0) {/*chunking hook*/}
    if(!row) continue; for(const cell of row){ if(cell==null) continue; const m=String(cell).match(/\b(\d{3,6}-\d{1,3})\b/g); if(m){ m.forEach(x=>supplierCores.add(x)); } } }
  $('sup-status').textContent = `Loaded ${sheetName} (${supplierCores.size} unique cores${coreCount?`, ${coreCount} total hits`:''})`;
  $('sup-status').className='pill ok';
  $('match-summary').textContent = 'Ready to build previews.';
}

// ===== Build Inventory Preview =====
function buildInventory(){
  const loc = $('invLocation').value.trim(); const qty = parseInt($('invAvailable').value||'0',10);
  if(!byCore.size){ toast('Upload Shopify Product export first.', 'warn'); return; }
  if(!supplierCores.size){ toast('Upload supplier file first.', 'warn'); return; }
  if(!loc){ toast('Enter inventory location (exact).', 'warn'); return; }
  const rows = [];
  let matched=0; const missed=[];
  for(const core of supplierCores){
    const arr = byCore.get(core);
    if(!arr || arr.length===0){ missed.push(core); continue; }
    matched += arr.length;
    for(const v of arr){
      rows.push({
        'Handle': v.handle,
        'Title': v.title,
        'Option1 Name': v.opt1n,
        'Option1 Value': v.opt1v,
        'Option2 Name': v.opt2n,
        'Option2 Value': v.opt2v,
        'Option3 Name': v.opt3n,
        'Option3 Value': v.opt3v,
        'SKU': v.sku,
        'WOHU': qty
      });
    }
  }
  invPreview = rows;
  // render inventory table
  const tb = document.querySelector('#inv-table tbody'); tb.innerHTML='';
  for(const r of rows){ const tr=document.createElement('tr'); ['Handle','Title','Option1 Name','Option1 Value','Option2 Name','Option2 Value','Option3 Name','Option3 Value','SKU','WOHU'].forEach(k=>{ const td=document.createElement('td'); td.textContent=r[k]??''; tr.appendChild(td); }); tb.appendChild(tr); }
  $('download-inventory').disabled = rows.length===0;
  // render unmatched
  renderUnmatched(missed);
  const msg = `Matched rows: ${matched}. Unmatched cores: ${missed.length}${missed.length? ' (e.g. '+missed.slice(0,6).join(', ')+(missed.length>6?'…':'')+')':''}`;
  $('match-summary').textContent = msg; if(missed.length) toast(msg, 'warn'); else toast('Inventory preview ready', 'ok');
}

function renderUnmatched(missed){
  unmatchedCores = Array.from(new Set(missed)).sort((a,b)=>a.localeCompare(b));
  const tb = document.querySelector('#unmatched-table tbody'); tb.innerHTML='';
  for(const core of unmatchedCores){ const tr=document.createElement('tr'); const td=document.createElement('td'); td.textContent=core; tr.appendChild(td); tb.appendChild(tr); }
  $('download-unmatched').disabled = unmatchedCores.length===0;
}

function downloadInventory(){
  const headers = ['Handle','Title','Option1 Name','Option1 Value','Option2 Name','Option2 Value','Option3 Name','Option3 Value','SKU','WOHU'];
  downloadCSV('inventory_by_sku_WOHU.csv', headers, invPreview);
}

function downloadUnmatched(){
  const headers=['Variant core'];
  const rows = unmatchedCores.map(c=>({'Variant core': c}));
  downloadCSV('unmatched_variant_cores.csv', headers, rows);
}

// ===== Build Tags Preview =====
function buildTags(){
  if(!byCore.size){ toast('Upload Shopify Product export first.', 'warn'); return; }
  if(!supplierCores.size){ toast('Upload supplier file first.', 'warn'); return; }
  const rows=[]; let matched=0; const missed=[];
  for(const core of supplierCores){ const arr = byCore.get(core); if(!arr || arr.length===0){ missed.push(core); continue; } for(const v of arr){ matched++; rows.push({handle:v.handle,title:v.title,sku:v.sku,existingTags:v.existingTags, addTags:''}); } }
  tagsPreview = rows;
  renderTagsTable();
  $('download-tags').disabled = rows.length===0;
  renderUnmatched(missed);
  toast('Tags preview ready'+(matched?` (${matched} variants)`:'') , matched? 'ok':'warn');
}

function renderTagsTable(){
  const tb=document.querySelector('#tags-table tbody'); tb.innerHTML='';
  for(const r of tagsPreview){ const tr=document.createElement('tr');
    const tdH = document.createElement('td'); tdH.textContent=r.handle; tr.appendChild(tdH);
    const tdT = document.createElement('td'); tdT.textContent=r.title; tr.appendChild(tdT);
    const tdS = document.createElement('td'); tdS.textContent=r.sku; tr.appendChild(tdS);
    const tdE = document.createElement('td'); tdE.textContent=r.existingTags; tr.appendChild(tdE);
    const tdA = document.createElement('td'); const inp=document.createElement('input'); inp.className='tags-input'; inp.placeholder='e.g. delisted, vendor-oos'; inp.value=r.addTags||''; inp.addEventListener('input', ()=>{ r.addTags=inp.value; }); tdA.appendChild(inp); tr.appendChild(tdA);
    tb.appendChild(tr);
  }
}

function applyGlobalTags(){
  const g = $('globalTags').value || '';
  tagsPreview.forEach(r=>{ r.addTags = g; });
  renderTagsTable();
}

function downloadTags(){
  const append = $('appendExisting').checked; const out=[];
  for(const r of tagsPreview){
    const add = (r.addTags||'').split(',').map(s=>s.trim()).filter(Boolean);
    let tags = [];
    if(append){
      tags = (r.existingTags||'').split(',').map(s=>s.trim()).filter(Boolean);
      for(const t of add){ if(!tags.includes(t)) tags.push(t); }
    } else {
      tags = add;
    }
    out.push({'Handle': r.handle, 'Tags': tags.join(', ')});
  }
  downloadCSV('product_tags_update.csv', ['Handle','Tags'], out);
}

// ===== Wire up =====
function wireDrop(el, onFile){ el.addEventListener('dragover', e=>{e.preventDefault(); el.classList.add('drag');}); el.addEventListener('dragleave', ()=>el.classList.remove('drag')); el.addEventListener('drop', e=>{e.preventDefault(); el.classList.remove('drag'); const f=e.dataTransfer.files[0]; if(f) onFile(f);}); }

(function init(){
  $('ref-file').addEventListener('change', e=>{ const f=e.target.files[0]; if(f) handleRefFile(f); });
  $('sup-file').addEventListener('change', e=>{ const f=e.target.files[0]; if(f) handleSupFile(f); });
  $('sheetSelect').addEventListener('change', e=>{ if(!lastWb) return; const val=e.target.value; if(!val){ chooseBestSheetAndSet(lastWb); return; } const ws=lastWb.Sheets[val]; if(!ws){ toast('Sheet not found', 'err'); return; } const rows = XLSX.utils.sheet_to_json(ws,{header:1,raw:true,defval:null}); setSupplierFromRows(rows, val); });
  wireDrop($('ref-drop'), handleRefFile);
  wireDrop($('sup-drop'), handleSupFile);

  $('build-inventory').addEventListener('click', buildInventory);
  const wrapUserClick = fn => (e)=>{ __USER_CLICK__ = true; try { fn(e); } finally { setTimeout(()=>{ __USER_CLICK__ = false; }, 0); } };
  $('download-inventory').addEventListener('click', wrapUserClick(downloadInventory));
  $('download-unmatched').addEventListener('click', wrapUserClick(downloadUnmatched));

  $('build-tags').addEventListener('click', buildTags);
  $('download-tags').addEventListener('click', wrapUserClick(downloadTags));
  $('apply-global-tags').addEventListener('click', applyGlobalTags);

  setBadge('Load product export first');
})();
</script>
</body>
</html>
